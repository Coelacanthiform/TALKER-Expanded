----------------------------------------------------------------------------------------------------
-- Artifact use and pick-ups
----------------------------------------------------------------------------------------------------

package.path = package.path .. ";./bin/lua/?.lua;"
local game = require("infra.game_adapter")
local trigger = require("interface.trigger")

local queries = talker_game_queries
local commands = talker_game_commands
----------------------------------------------------------------------------------------------------
-- Constants
----------------------------------------------------------------------------------------------------
local ARTIFACT_COMMENT_CD = 20 * 1000 -- 20 seconds
----------------------------------------------------------------------------------------------------
-- Conditions
----------------------------------------------------------------------------------------------------
local function is_excluded_artifact(name)
    if not name then return false end
    local lower_name = string.lower(name)
    if string.find(lower_name, "oxygen") or string.find(lower_name, "filter") then
        return true
    end
    return false
end

local LAST_ARTIFACT_COMMENT = 0

function is_valid_event(artifact_name)
    if is_excluded_artifact(artifact_name) then return false end   
    if not game.is_cooldown_over(LAST_ARTIFACT_COMMENT, ARTIFACT_COMMENT_CD) then 
        return false 
    end

    LAST_ARTIFACT_COMMENT = queries.get_game_time_ms()
    return true
end

----------------------------------------------------------------------------------------------------
-- Handlers
----------------------------------------------------------------------------------------------------


local function actor_on_item_use(obj)
    if not queries.is_artifact(obj) then return end
    
    local artifact = queries.get_item_name(obj)
    if not is_valid_event(artifact) then return end

    local player = game.get_player_character()
    local witnesses = game.get_characters_near_player()
    local unformatted_description = "%s, a %s rank member of the %s faction used an artifact called %s"
    trigger.talker_game_event(unformatted_description, {player.name, player.experience, player.faction, artifact}, witnesses, true)
end

local function actor_on_item_before_pickup(obj)
    if not queries.is_artifact(obj) then return end

    local artifact = queries.get_item_name(obj)
    if not is_valid_event(artifact) then return end

    local player = game.get_player_character()
    local witnesses = game.get_characters_near_player()
    local unformatted_description = "%s, a %s rank member of the %s faction picked up an artifact called %s"
    trigger.talker_game_event(unformatted_description, {player.name, player.experience, player.faction, artifact}, witnesses, true)
end


----------------------------------------------------------------------------------------------------
-- Setup
----------------------------------------------------------------------------------------------------

function on_game_start()
    commands.RegisterSafeScriptCallback("actor_on_item_before_pickup", actor_on_item_before_pickup)
    commands.RegisterSafeScriptCallback("actor_on_item_use", actor_on_item_use)
end

function is_loaded()
    return true
end
